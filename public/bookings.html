<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkGo – Mina förfrågningar</title>
    <link rel="stylesheet" href="./tokens.css">
    <script src="./config.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
        }
        .appbar {
            position: sticky;
            top: 0;
            background: var(--surface);
            border-bottom: 1px solid var(--muted);
            padding: var(--m) var(--l);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }
        .appbar .left {
            font-size: 1.1em;
        }
        .appbar .right button {
            padding: var(--s) var(--m);
            border: 1px solid var(--muted);
            background: var(--surface);
            border-radius: 6px;
            cursor: pointer;
        }
        .debug-badge {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
            z-index: 1000;
        }
        .debug-badge[hidden] {
            display: none;
        }
        #msg {
            padding: var(--m);
            margin: var(--m) var(--l);
            border-radius: 6px;
            font-weight: 500;
        }
        .msg-error { background: #fee2e2; color: #991b1b; }
        .msg-success { background: #d1fae5; color: #065f46; }
        .msg-info { background: #dbeafe; color: #1e40af; }
        .card {
            margin: var(--l);
            background: var(--surface);
            border: 1px solid var(--muted);
            border-radius: 12px;
            padding: var(--xl);
        }
        .tabs {
            display: flex;
            gap: var(--s);
            margin-bottom: var(--l);
        }
        .tabs button {
            padding: var(--m) var(--l);
            border: 1px solid var(--muted);
            background: var(--muted);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tabs button.active {
            background: var(--primary);
            color: var(--surface);
            border-color: var(--primary);
        }
        .item {
            background: var(--muted);
            border-radius: 8px;
            padding: var(--l);
            margin-bottom: var(--m);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .meta {
            flex: 1;
        }
        .meta div {
            margin-bottom: var(--xs);
            color: var(--text);
        }
        .status {
            margin-left: var(--m);
        }
        .chip {
            padding: var(--xs) var(--s);
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 500;
        }
        .chip.requested { background: #fef3c7; color: #92400e; }
        .chip.accepted { background: #d1fae5; color: #065f46; }
        .chip.declined { background: #fee2e2; color: #991b1b; }
        .actions {
            margin-left: var(--m);
            display: flex;
            gap: var(--s);
        }
        .actions button {
            padding: var(--s) var(--m);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
        }
        .actions button[data-act="accepted"] {
            background: #10b981;
            color: white;
        }
        .actions button[data-act="declined"] {
            background: #ef4444;
            color: white;
        }
        .actions button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pager {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--l);
        }
        .pager button {
            padding: var(--s) var(--m);
            border: 1px solid var(--muted);
            background: var(--surface);
            border-radius: 6px;
            cursor: pointer;
        }
        .pager button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <header id="appbar" class="appbar">
        <div class="left">
            <strong>LinkGo</strong> · <span>Mina förfrågningar</span>
        </div>
        <div class="right">
            <button id="btn-logout">Logga ut</button>
        </div>
    </header>
    
    <div id="debug" class="debug-badge" hidden></div>
    <p id="msg" role="status" aria-live="polite"></p>

    <main class="card">
        <nav class="tabs">
            <button id="tab-incoming">Inkommande</button>
            <button id="tab-all">Alla</button>
        </nav>
        <div id="list"></div>
        <footer class="pager">
            <button id="btn-prev">Prev</button>
            <span id="page-info"></span>
            <button id="btn-next">Next</button>
        </footer>
    </main>

    <script type="module">
        import supa from '../js/supa.js';

        const $ = (id) => document.getElementById(id);
        const fmt = (iso) => {
            try { return new Intl.DateTimeFormat('sv-SE', { dateStyle: 'medium', timeStyle: 'short' }).format(new Date(iso)); }
            catch { return iso; }
        };
        function setMsg(text, type='info') { const el=$('msg'); if(!el) return; el.textContent=text||''; el.className=type; }

        // Guard + session
        await supa.Auth.protectPage('talent');
        const me = await supa.Auth.getMyProfile();

        // Debug-badge
        const dbg = $('debug');
        if (window.CONFIG?.DEBUG) {
            dbg.hidden = false;
            dbg.textContent = `${location.origin} • ${me?.data?.email||'okänd'} • roll:${me?.data?.role||'–'}`;
        }

        // Logout
        $('btn-logout').addEventListener('click', async () => {
            try { await supa.Auth.signOut(); location.href = './login.html'; }
            catch (e) { setMsg('Kunde inte logga ut', 'error'); console.error(e); }
        });

        // Tabs + state
        const state = {
            tab: localStorage.getItem('bookings.tab') || 'incoming',
            cursor: null,
            limit: 10,
        };
        const tabIncoming = $('tab-incoming');
        const tabAll = $('tab-all');
        const list = $('list');
        const pageInfo = $('page-info');

        function selectTab(t) {
            state.tab = t; state.cursor = null;
            localStorage.setItem('bookings.tab', t);
            tabIncoming.classList.toggle('active', t==='incoming');
            tabAll.classList.toggle('active', t==='all');
            load();
        }

        tabIncoming.addEventListener('click', () => selectTab('incoming'));
        tabAll.addEventListener('click', () => selectTab('all'));

        // Rendering
        function rowCard(row) {
            const start = fmt(row.start_date);
            const end = fmt(row.end_date);
            const disabled = row.status !== 'requested';
            const actions = disabled ? '' : `
                <div class="actions">
                    <button data-act="accepted" data-id="${row.id}">Acceptera</button>
                    <button data-act="declined" data-id="${row.id}">Avböj</button>
                </div>`;
            return `
                <article class="item">
                    <div class="meta">
                        <div><strong>${row.manager?.full_name || row.manager_id}</strong></div>
                        <div>${row.location || '-'}</div>
                        <div>${start} – ${end}</div>
                        <div>${row.message || ''}</div>
                    </div>
                    <div class="status"><span class="chip ${row.status}">${row.status}</span></div>
                    ${actions}
                </article>`;
        }

        async function load(dir) {
            try {
                setMsg('Laddar...', 'info');
                let data;
                if (state.tab === 'incoming') {
                    data = await supa.Bookings.listIncomingForTalent({ limit: state.limit, cursor: state.cursor });
                } else {
                    data = await supa.Bookings.listAllForTalent({ limit: state.limit, cursor: state.cursor });
                }
                list.innerHTML = (data.items || []).map(rowCard).join('') || '<p>Inget att visa.</p>';
                pageInfo.textContent = `${(data.items||[]).length} st`;

                // Wire actions
                list.querySelectorAll('button[data-id]').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        const act = e.currentTarget.getAttribute('data-act');
                        e.currentTarget.disabled = true;
                        try {
                            await supa.Bookings.respond({ booking_id: id, action: act });
                            setMsg(act === 'accepted' ? 'Förfrågan accepterad.' : 'Förfrågan avböjd.', 'success');
                            await load(); // refresh
                        } catch (err) {
                            console.error(err);
                            setMsg('Kunde inte uppdatera bokningen.', 'error');
                        } finally {
                            e.currentTarget.disabled = false;
                        }
                    });
                });

                // Simple prev/next demo (behåll offset i list-metoderna)
                $('btn-prev').onclick = async () => { /* valfritt: uppdatera state.cursor bakåt */ };
                $('btn-next').onclick = async () => { /* valfritt: uppdatera state.cursor framåt */ };

                setMsg('');
            } catch (e) {
                console.error(e);
                setMsg('Fel vid laddning av bokningar.', 'error');
            }
        }

        // Init
        selectTab(state.tab);
    </script>
</body>
</html>