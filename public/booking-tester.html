<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <title>LinkGo – Booking Tester</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Design tokens & config -->
  <link rel="stylesheet" href="./tokens.css" />
  <script src="./config.js"></script>

  <style>
    :root {
      /* fallbacks if tokens.css misses any */
      --surface: #0b0b0c;
      --muted: #2a2a2d;
      --text: #e7e7ea;
      --subtle: #9a9aa0;
      --accent: #4c8bf5;
      --danger: #e25555;
      --success: #34c759;
    }
    body {
      margin: 0;
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--app-bg, #0a0a0b);
      color: var(--text);
    }
    .card {
      max-width: 720px;
      margin: 48px auto;
      padding: 24px;
      border: 1px solid var(--muted);
      border-radius: 16px;
      background: var(--surface);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    h1 {
      margin: 0 0 12px;
      font-weight: 650;
      letter-spacing: .2px;
    }
    .sub {
      color: var(--subtle);
      margin-bottom: 16px;
      font-size: 14px;
    }
    section {
      border-top: 1px solid var(--muted);
      padding-top: 16px;
      margin-top: 16px;
    }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: end; }
    .col { flex: 1 1 240px; min-width: 220px; }
    label { display:block; font-size: 12px; color: var(--subtle); margin-bottom: 6px; }
    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      background: #111214;
      border: 1px solid var(--muted);
      border-radius: 10px;
      color: var(--text);
      outline: none;
    }
    textarea { min-height: 60px; resize: vertical; }
    .btns { display: flex; gap: 10px; flex-wrap: wrap; }
    button {
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid var(--muted);
      background: #131416;
      color: var(--text);
      cursor: pointer;
    }
    button.primary { border-color: transparent; background: var(--accent); color: white; }
    button.ghost { background: transparent; }
    button.danger { background: #2a1313; border-color: #3a1a1a; color: #ffb3b3; }
    pre {
      width: 100%;
      background: #0e0f11;
      border: 1px solid var(--muted);
      border-radius: 12px;
      padding: 12px;
      overflow: auto;
      max-height: 240px;
      line-height: 1.35;
      font-size: 12px;
    }
    .outputs { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 16px; }
    @media (min-width: 800px) {
      .outputs { grid-template-columns: 1fr 1fr 1fr; }
    }
    .hint {
      font-size: 12px;
      color: var(--subtle);
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>LinkGo – Booking Tester</h1>
    <div class="sub">Manuell testpanel för <code>Bookings.*</code> i <code>../js/supa.js</code>.</div>

    <!-- Session -->
    <section>
      <h3>Session</h3>
      <div class="btns">
        <button id="btn-whoami">Who am I?</button>
        <button id="btn-logout" class="ghost">Logout</button>
      </div>
    </section>

    <!-- Request booking (manager) -->
    <section>
      <h3>Request booking (manager)</h3>
      <div class="row">
        <div class="col">
          <label for="rq-talent_id">talent_id</label>
          <input id="rq-talent_id" placeholder="klistra in talent-id från validate/login (ex. ref2)" />
        </div>
        <div class="col">
          <label for="rq-role_at_booking">role_at_booking</label>
          <select id="rq-role_at_booking">
            <option value="referee" selected>referee</option>
            <option value="coach">coach</option>
          </select>
        </div>
        <div class="col">
          <label for="rq-start_ts">start_ts</label>
          <input id="rq-start_ts" type="datetime-local" />
          <div class="hint">Tomt → auto: i morgon 18:00–19:30</div>
        </div>
        <div class="col">
          <label for="rq-end_ts">end_ts</label>
          <input id="rq-end_ts" type="datetime-local" />
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <div class="col">
          <label for="rq-location">location</label>
          <input id="rq-location" placeholder="Skytteholms IP" />
        </div>
        <div class="col" style="flex:2 1 100%;">
          <label for="rq-message">message</label>
          <input id="rq-message" placeholder="Träningsmatch U13" />
        </div>
      </div>
      <div class="btns" style="margin-top:12px;">
        <button id="btn-send-request" class="primary">Send request</button>
      </div>
    </section>

    <!-- Respond booking (talent) -->
    <section>
      <h3>Respond booking (talent)</h3>
      <div class="row">
        <div class="col">
          <label for="rs-booking_id">booking_id</label>
          <input id="rs-booking_id" placeholder="ex. 123" />
        </div>
        <div class="col">
          <label for="rs-action">action</label>
          <select id="rs-action">
            <option value="accept">accept</option>
            <option value="decline">decline</option>
            <option value="cancel">cancel</option>
          </select>
        </div>
      </div>
      <div class="btns" style="margin-top:12px;">
        <button id="btn-send-response" class="primary">Send response</button>
      </div>
    </section>

    <!-- List mine -->
    <section>
      <h3>List mine</h3>
      <div class="row">
        <div class="col">
          <label for="ls-role">role</label>
          <select id="ls-role">
            <option value="manager">manager</option>
            <option value="talent">talent</option>
          </select>
        </div>
        <div class="col">
          <label for="ls-status">status</label>
          <select id="ls-status">
            <option value="">(tom)</option>
            <option value="requested">requested</option>
            <option value="accepted">accepted</option>
            <option value="declined">declined</option>
            <option value="cancelled">cancelled</option>
          </select>
        </div>
        <div class="col">
          <label for="ls-from">from (date)</label>
          <input id="ls-from" type="date" />
        </div>
        <div class="col">
          <label for="ls-to">to (date)</label>
          <input id="ls-to" type="date" />
        </div>
        <div class="col">
          <label for="ls-limit">limit</label>
          <input id="ls-limit" type="number" min="1" step="1" placeholder="10" />
        </div>
      </div>
      <div class="btns" style="margin-top:12px;">
        <button id="btn-list" class="primary">List</button>
      </div>
    </section>

    <!-- Get booking -->
    <section>
      <h3>Get booking</h3>
      <div class="row">
        <div class="col">
          <label for="gt-booking_id">booking_id</label>
          <input id="gt-booking_id" placeholder="ex. 123" />
        </div>
      </div>
      <div class="btns" style="margin-top:12px;">
        <button id="btn-get" class="primary">Get</button>
      </div>
    </section>

    <!-- Outputs -->
    <section>
      <h3>Output</h3>
      <div class="outputs">
        <div>
          <label>Session / Profile</label>
          <pre id="out-session">{}</pre>
        </div>
        <div>
          <label>Latest result</label>
          <pre id="out-result">{}</pre>
        </div>
        <div>
          <label>Errors / Log</label>
          <pre id="out-log">[]</pre>
        </div>
      </div>
    </section>
  </div>

  <script type="module">
    import supa from '../js/supa.js';

    const $ = (id) => document.getElementById(id);
    const set = (id, obj) => {
      const el = $(id);
      if (!el) return;
      el.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
    };
    const appendLog = (entry) => {
      try {
        const el = $('out-log');
        const cur = el.textContent.trim();
        const arr = cur ? JSON.parse(cur) : [];
        arr.push(entry);
        el.textContent = JSON.stringify(arr, null, 2);
      } catch (e) {
        // fallback
        $('out-log').textContent = String(entry);
      }
    };

    // Helpers: default next-day 18:00–19:30 local → ISO UTC with Z
    function nextDayLocalAt(h, m) {
      const now = new Date();
      const d = new Date(now);
      d.setDate(now.getDate() + 1);
      d.setHours(h, m, 0, 0);
      return d;
    }
    function toIsoZ(d) {
      // Ensure :00Z formatting
      return new Date(d).toISOString().replace(/\.\d{3}Z$/, 'Z');
    }

    async function showSession() {
      const { data, error } = await supa.Auth.getSession();
      if (error) appendLog({ where: 'getSession', error: error.message });
      set('out-session', data ?? { session: null });
    }

    // On load
    (async () => {
      console.log('[booking-tester] wired');
      await showSession();
    })();

    // Session buttons
    $('btn-whoami').addEventListener('click', async () => {
      const { data, error } = await supa.Profiles.getMyProfile();
      if (error) appendLog({ where: 'getMyProfile', error: error.message });
      set('out-session', data ?? { profile: null });
    });

    $('btn-logout').addEventListener('click', async () => {
      const { error } = await supa.Auth.signOut();
      if (error) appendLog({ where: 'signOut', error: error.message });
      set('out-session', 'signed out');
    });

    // Send request
    $('btn-send-request').addEventListener('click', async () => {
      // Gather fields
      const talent_id = $('rq-talent_id').value.trim();
      const role_at_booking = $('rq-role_at_booking').value;
      const startInp = $('rq-start_ts').value; // datetime-local (local)
      const endInp = $('rq-end_ts').value;
      const location = $('rq-location').value.trim() || 'Skytteholms IP';
      const message = $('rq-message').value.trim() || 'Träningsmatch U13';

      // Prefill default times if empty
      let start_ts, end_ts;
      if (!startInp || !endInp) {
        const s = nextDayLocalAt(18, 0);
        const e = nextDayLocalAt(19, 30);
        start_ts = toIsoZ(s);
        end_ts = toIsoZ(e);
      } else {
        // Convert local to ISO Z
        const s = new Date(startInp);
        const e = new Date(endInp);
        start_ts = toIsoZ(s);
        end_ts = toIsoZ(e);
      }

      const payload = { talent_id, role_at_booking, start_ts, end_ts, location, message };
      const { data, error } = await supa.Bookings.request(payload);
      if (error) appendLog({ where: 'Bookings.request', payload, error: error.message });
      set('out-result', data ?? { ok: false });
    });

    // Send response
    $('btn-send-response').addEventListener('click', async () => {
      const booking_id = $('rs-booking_id').value.trim();
      const action = $('rs-action').value;
      const payload = { booking_id, action };
      const { data, error } = await supa.Bookings.respond(payload);
      if (error) appendLog({ where: 'Bookings.respond', payload, error: error.message });
      set('out-result', data ?? { ok: false });
    });

    // List mine
    $('btn-list').addEventListener('click', async () => {
      const role = $('ls-role').value;
      const status = $('ls-status').value;
      const from = $('ls-from').value;
      const to = $('ls-to').value;
      const limitRaw = $('ls-limit').value;
      const limit = parseInt(limitRaw || '10', 10);

      const filter = {};
      if (role) filter.role = role;
      if (status) filter.status = status;
      if (from) filter.from = from;
      if (to) filter.to = to;
      if (limit) filter.limit = limit;

      const { data, error } = await supa.Bookings.listMine(filter);
      if (error) appendLog({ where: 'Bookings.listMine', filter, error: error.message });

      // Compact projection for output
      const compact = Array.isArray(data)
        ? data.map(r => ({
            id: r.id,
            role_at_booking: r.role_at_booking,
            status: r.status,
            start_ts: r.start_ts,
            end_ts: r.end_ts,
            location: r.location
          }))
        : data;

      set('out-result', compact ?? []);
    });

    // Get booking
    $('btn-get').addEventListener('click', async () => {
      const booking_id = $('gt-booking_id').value.trim();
      const { data, error } = await supa.Bookings.get({ booking_id });
      if (error) appendLog({ where: 'Bookings.get', booking_id, error: error.message });
      set('out-result', data ?? { ok: false });
    });
  </script>
</body>
</html>
